
## Test

### 测试用例(benchmarks/benchmark_lab.py)
`py benchmark.py --tokenizer facebook/opt-125m --request-rate $para1 --dataset $para2 --num-prompts $para3`
本次测试选用模型为facebook/opt-125m,以num-prompts参数指定总请求数量，以dataset限定输入输出的句子长度————以所传参数为中心的泊松分布，以request-rate指定请求频率————两次请求间隔时长为以所传参数为中心的泊松分布。
通过调整测试用例输入参数，模拟不同用户请求场景：
| 模拟场景   | 请求频率(r/s) | 句子长度 | 请求量 |
|------------|---------------|----------|--------|
| 密集短对话 | 1000          | 20       | 1000   |
| 密集长对话 | 1000          | 80       | 1000   |
| 稀松短对话 | 100           | 20       | 100    |
| 稀松长对话 | 100           | 80       | 100    |
通过更改vllm所选用的调度算法，对比不同调度算法在不同场景下的性能。

所有用例测量三次取平均值。

### 测试结果
#### 各调度算法性能
| 调度算法 | 模拟场景   | 请求频率(r/s) | 句子长度 | 请求量 | 总执行时间(s) | 吞吐量(r/s) | 平均请求时延(s) |
|----------|------------|---------------|----------|--------|---------------|-------------|-----------------|
| FIFO     | 密集短对话 | 1000          | 20       | 1000   | 5.98          | 167.23      | 3.25            |
|          | 密集长对话 | 1000          | 80       | 1000   | 23.86         | 41.90       | 12.24           |
|          | 稀松短对话 | 100           | 20       | 100    | 1.50          | 66.74       | 0.33            |
|          | 稀松长对话 | 100           | 80       | 100    | 2.70          | 37.02       | 0.78            |
| STATIC   | 密集短对话 | 1000          | 20       | 1000   | 6.15          | 162.57      | 3.40            |
|          | 密集长对话 | 1000          | 80       | 1000   | 20.18         | 49.56       | 11.14           |
|          | 稀松短对话 | 100           | 20       | 100    | 1.79          | 55.95       | 0.59            |
|          | 稀松长对话 | 100           | 80       | 100    | 2.70          | 37.08       | 0.74            |
| SJF      | 密集短对话 | 1000          | 20       | 1000   | 6.30          | 158.63      | 3.23            |
|          | 密集长对话 | 1000          | 80       | 1000   | 21.49         | 46.53       | 11.74           |
|          | 稀松短对话 | 100           | 20       | 100    | 1.51          | 66.40       | 0.34            |
|          | 稀松长对话 | 100           | 80       | 100    | 2.73          | 36.61       | 0.73            |
| LDF      | 密集短对话 | 1000          | 20       | 1000   | 6.81          | 146.89      | 3.91            |
|          | 密集长对话 | 1000          | 80       | 1000   | 20.94         | 47.76       | 11.93           |
|          | 稀松短对话 | 100           | 20       | 100    | 1.57          | 63.52       | 0.38            |
|          | 稀松长对话 | 100           | 80       | 100    | 2.66          | 37.54       | 0.72            |
| LCFS     | 密集短对话 | 1000          | 20       | 1000   | 6.03          | 165.85      | 3.40            |
|          | 密集长对话 | 1000          | 80       | 1000   | 20.38         | 49.07       | 11.33           |
|          | 稀松短对话 | 100           | 20       | 100    | 1.56          | 64.07       | 0.37            |
|          | 稀松长对话 | 100           | 80       | 100    | 2.85          | 35.13       | 0.92            |

#### 各场景调度算法对比
| 模拟场景   | 调度算法 | 总执行时间(s) | 吞吐量(r/s) | 平均请求时延(s) |
|------------|----------|---------------|-------------|-----------------|
| 密集短对话 | FIFO     | 5.98          | 167.23      | 3.25            |
|            | STATIC   | 6.15          | 162.57      | 3.40            |
|            | SJF      | 6.30          | 158.63      | 3.23            |
|            | LDF      | 6.81          | 146.89      | 3.91            |
|            | LCFS     | 6.03          | 165.85      | 3.40            |
| 密集长对话 | FIFO     | 23.86         | 41.90       | 12.24           |
|            | STATIC   | 20.18         | 49.56       | 11.14           |
|            | SJF      | 21.49         | 46.53       | 11.74           |
|            | LDF      | 20.94         | 47.76       | 11.93           |
|            | LCFS     | 20.38         | 49.07       | 11.33           |
| 稀松短对话 | FIFO     | 1.50          | 66.74       | 0.33            |
|            | STATIC   | 1.79          | 55.95       | 0.59            |
|            | SJF      | 1.51          | 66.40       | 0.34            |
|            | LDF      | 1.57          | 63.52       | 0.38            |
|            | LCFS     | 1.56          | 64.07       | 0.37            |
| 稀松长对话 | FIFO     | 2.70          | 37.02       | 0.78            |
|            | STATIC   | 2.70          | 37.08       | 0.74            |
|            | SJF      | 2.73          | 36.61       | 0.73            |
|            | LDF      | 1.56          | 64.07       | 0.37            |
|            | LCFS     | 2.85          | 35.13       | 0.92            |

#### 结果分析
通过同一调度不同场景的对比与分析：
- 随着输入输出句子长度的增加，请求负载增加，网络需要处理的token增加，吞吐量下降，请求时延增加。
- 随着请求频率的的增加，server端单位时间内处理请求数量增加，吞吐量增加，直至达到瓶颈；等待时间增加，时延变长。
不同调度算法的对比与分析：
todo：